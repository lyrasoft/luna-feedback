{"version":3,"sources":["rating-button.ts"],"names":[],"mappings":"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","file":"rating-button.js","sourcesContent":["import '@main';\n\nclass RatingButton {\n  icon: HTMLElement | null;\n\n  rated: boolean;\n  type: string;\n  id: string;\n\n  constructor(protected el: HTMLElement) {\n    this.icon = el.querySelector('i, span');\n    const rated = el.dataset.rated;\n\n    this.rated = rated === '1' || rated === 'true';\n    this.type = el.dataset.type || '';\n    this.id = el.dataset.id || '';\n\n    this.el.addEventListener('click', async () => {\n      await this.toggle();\n      this.refreshStyle();\n    });\n\n    this.refreshStyle();\n  }\n\n  async toggle() {\n    const config = u.data('rating');\n\n    if (!config.isLogin) {\n      location.href = config.loginUri;\n      return;\n    }\n\n    const task = this.rated ? 'remove' : 'add';\n\n    const ratedBak = this.rated;\n\n    this.rated = !this.rated;\n    this.el.dataset.rated = this.rated ? '1' : '0';\n\n    try {\n      const res = await u.$http.post(\n        `@rating_ajax/${task}`,\n        {\n          targetId: this.id,\n          type: this.type,\n        }\n      );\n\n      this.el.dispatchEvent(\n        new CustomEvent('rated', {\n          detail: {\n            rated: !this.rated,\n            task,\n            type: this.type,\n            message: res.data.message,\n          },\n          bubbles: true\n        })\n      );\n    } catch (e) {\n      this.rated = ratedBak;\n      this.el.dataset.rated = this.rated ? '1' : '0';\n\n      console.error(e);\n      if (e instanceof Error) {\n        u.alert(e.message, '', 'warning');\n      }\n      throw e;\n    }\n  }\n\n  refreshStyle() {\n    if (this.el.dataset.classInactive || this.el.dataset.classActive) {\n      this.el.classList.remove(\n        ...this.classToList(this.el.dataset.classInactive || ''),\n        ...this.classToList(this.el.dataset.classActive || '')\n      );\n    }\n\n    if (this.rated) {\n      this.icon?.setAttribute('class', this.el.dataset.iconActive || '');\n\n      if (this.el.dataset.classActive) {\n        this.el.classList.add(\n          ...this.classToList(this.el.dataset.classActive)\n        );\n      }\n\n      this.el.setAttribute('data-bs-original-title', this.el.dataset.titleActive || '');\n    } else {\n      this.icon?.setAttribute('class', this.el.dataset.iconInactive || '');\n\n      if (this.el.dataset.classInactive) {\n        this.el.classList.add(\n          ...this.classToList(this.el.dataset.classInactive)\n        );\n      }\n\n      this.el.setAttribute('data-bs-original-title', this.el.dataset.titleInactive || '');\n    }\n\n    setTimeout(() => {\n      const tooltip = u.$ui.bootstrap.tooltip(this.el);\n      tooltip.update();\n    }, 50);\n  }\n\n  classToList(className: string): string[] {\n    return className.split(' ').filter((t) => t !== '');\n  }\n}\n\nu.directive(\n  'rating-button',\n  {\n    mounted(el: HTMLElement) {\n      setTimeout(() => {\n        u.module(el, 'rating.button', () => new RatingButton(el));\n      }, 0);\n    }\n  }\n);\n"]}